# **CVAT2TrainedYOLOv5**

## О репозитории

Репозиторий предоставляет пайплайн обучения модели детекции объектов на изображениях, размеченных в CVAT. Реализовано на базе модели **YoloV5**.

## Volumes

* _./config:/config_ - каталог с конфигурационными файлами

* _./weights:/weights_ - каталог с весами модели (для извлечения обученных, передачи инициализированных и использования существующих весов для валидации модели)

* _./dataset:/dataset_ - каталог с датасетом yolov5

* _./test:/test_ - каталог с данными для валидации (csv-файлы с предсказаниями и истинными метками)

* _./testingimages:/test/images_ - каталог с изображениями для парсинга (test_parse.py). Также в /test/images сохряняются тестовые изображения, отложенные из обучающей выборки (по умолчанию опция выключена)

* _/input:/input_ - каталог с изображениями и сырой разметкой. Предполагается, что структура каталога выглядит следующим образом:

    
        ├───{root}
            ├───{folder_1}
                ├───{subfolder_1}
                    ├───images
                        ├───*.jpg
                        ...
                        └───*.jpg
                    ├───annotations.xml
                ...
                ├───{subfolder_N}
            ...
            └───{folder_M}

(Каталог images необязателен)

## Скрипты:

1. **preprocessing**.**py** - скрипт для парсинга **xml**, разбиения _/input_ выборки на _train/val/test_  и формирования датасета формата **Yolov5**. Если нет необходимости откладывать тестовую выборку, то нужно изменить параметр train_test_split.test_query в конфигурационном файле (см. описание конфигурационных параметров).
* **Аргументы**
        --config - путь до конфигурационного файла (по умолчанию /config/config.yaml)
    
2. **train**.**py** - скрипт обучения модели **Yolov5** на датасете, полученном из пункта **1**, либо на датасете, собранном за пределами проекта. Параметры обучения находятся в  _/config/config.yaml_, а также в _/config/model_config.yaml_. Обученные веса сохраняются в каталог, прописанный в параметре _model['weights']_ (_/config/config.yaml_);
* **Аргументы**
        --config - путь до конфигурационного файла (по умолчанию /config/config.yaml)
        --yolo_engine - путь до сабмодуля Yolov5(по умолчанию /root/yolov5)
    
3. **evaluate**.**py** - скрипт, используемый для валидации модели. Принимает на вход 2 **csv** файла (предсказания и истинные метки) и выводит метрики в стандартный поток вывода.
Для того, чтобы оценить модель, необходимо воспользоваться скриптом **test_parse**.**py** для парсинга **xml**-аннотаций тестовых изображений в **csv** (если тестовый набор не был сгенерирован посредством **preprocessing**.**py**, иначе тестовые метки уже имеются, и данный шаг не нужен).
* **Аргументы**
        --pred - путь до **csv** файла с предсказаниями
        --test - путь до **csv** файла с истинными метками (по умолчанию /test/test.csv)
    
4. **test_parse**.**py** - скрипт для парсинга **xml**-аннотаций тестовых изображений в **csv** (используется в случае, когда нет **csv** с истинными метками для тестовых изображений). Результатом работы является **csv**-файл с тестовыми метками.
Структура каталога тестовых изображений должна быть такой же, как и у Input Volumes.
* **Аргументы**
        --test_images - путь до каталога с тестовыми изображениями (по умолчанию /test/images)
        --test_labels - путь для сохранения **csv** файла с тестовыми метками (по умолчанию /test/test.csv)

## Описание конфигурационных параметров

* **source** - путь до каталога с тренировочными изображениями и **xml** разметкой. Структура каталога описана выше

* **train_test_split** - параметры разделения исходной выборки
        
        test_query - фильтр для тестовой выборки. Например:
            #test_query: "(date == None)" - не откладывать тестовую выборку
        valid_size - доля валидационной выборки
        random_state - фиксация рандома

* **dataset** - пути для генерируемого датасета
    
        yolo_dataset - путь до каталога

* **test** - пути для тестовых данных, генериремых в скрипте **preprocessing**.**py**

        test_images - путь до каталога с тестовыми изображениями;
        test_labels - путь до csv файла с тестовывми метками.

* **model** - параметры обучения модели
  
        model_params - путь до yaml файла с параметрами модели
        project - название каталога, куда будут записываться артефакты обучения за все запуски
        run_name - название каталога, куда будут записываться артефакты обучения одного запуска (подкаталог project)
        model - тип модели. Например, yolov5l
        weights - путь до файла с весами, используемого для инициализации модели
        epochs - количество эпох обучения
        imgsz - размер входного изображения
        patience - количество эпох для EarlyStopping
        batch_size - размер батча
        lr_flip - бинарный флаг для использования left-right flip аугментации


* **classes** - отображения классов в индексы и наоборот
  pos2class - словарь вида название класса: идентификатор
  class2pos - список названий классов

## Сборка образа docker

```
git submodule update --init
docker-compose build train
```

## Запуск контейнера

```
docker-compose run --rm train
```

## Пример: запуск скрипта вместе с контейнером

```
docker-compose run --rm train -c "python preprocessing.py"
```

### Запускается в контейнере:

## Препроцессинг

```
python preprocessing.py --config=/config/config.yaml
```

## Обучение

```
python train.py --config=/config/config.yaml
```

## Валидация
```
python evaluate.py --pred={путь то csv предсказаний} --test={путь до csv с истинными метками} --join_poses={True/False - использование объединения лежачих поз}
```

## Парсинг тестовых xml аннотаций
```
python test_parse.py --test_images={путь до каталога с тестовыми изображениями} --test_labels={путь для сохранения csv меток}
```
